每次打完滴滴, 我们都可以分享领券页面到朋友圈, 让大家一起来领券. 而领完券后, 一大堆券5折的券到账的感觉一定很爽(可惜现在的折扣越来越少了). 想必大家都对滴滴的优惠券影响深刻. 滴滴的用户规模如此之大, 送券力度如此之高, 如果由我们来做,该如何构架这样一个稳定且有扩展性的系统呢?

##扩展的分类
一个稳定的系统,除了需要由实现系统时健壮的代码来保证外, 架构上的拆分,也会有相当大的影响.
比如:我们将**易变的**模块(需求变化频繁)和**稳定的**模块糅合在一起部署的话, 变化的逻辑造成整个系统频繁的部署,会给系统带来极大的风险.
所以扩展性在系统设计一开始就需要着重考虑. 我们这里主要考虑这两个方面的扩展:
1. 业务扩展
变更或新增业务逻辑时, 尽量对已有的核心模块影响最小,保证系统整体的稳定性.
2. 性能扩展
保证系统是可以*水平扩展*的, 从而具有应对更高的负载能力.
##功能和性能需求:
抛开具体业务的架构都是耍流氓, 那我们先从功能和性能需求上对要做的优惠券系统有个整体上的认识, 来看看哪些需求是易变的,哪些需求是稳定的.
###优惠券的生命周期
优惠券作为在线交易系统(电商,O2O)的一种重要营销手段, 每张优惠券的生命周期都又两个阶段组成:
- 发券
可以由运营创建一个优惠券活动, 让用户主动领券, 也可以让由运营对制定范围内的用户批量发券.
- 用券
消费者收到优惠券后,在结算页从优惠券列表中选择优惠券并使用.

###发券

####优惠券活动管理

####优惠券发券
从瞬时单次发券的用户数量来看, 发券活动分为:
1. 对单用户发券:
用户大促抽奖领券,新用户注册领券,订单完成后返券以及对投诉用户补偿券时会采用这种领券活动.
 - 从功能上看,对单用户发券的玩法多种多样,逻辑变化较频繁.
 - 从性能上看,单用户发券请求量很高,同时也非常强调及时性,在用户触发发券条件后,应当尽可能快的保证券到达用户账户.
2. 对多用户发券:
 - 从功能上看,在补贴大战,提升交易额以及唤醒沉睡的老用户时会采用,一般会结合短信通知和邮件通知来让用户知晓有优惠券到账. 多用户发券的业务较为单一,一般是运营人员通过后台选择用户范围后触发.
 - 从性能上看,对多用户发券的请求量较小,但发券量比较大,可能多大上百万,所以多用户发券更强调发券的稳定性.

###用券

####促销方式
从券的促销方式来看, 优惠券种类一般有:
1. 立减: 
优惠金额固定的优惠券, 比如滴滴的现金券.
2. 折扣: 
优惠金额跟订单金额成比例的优惠券, 比如滴滴的折扣券.
3. 其他促销

不同的优惠券促销方式, 会对应不同的优惠金额计算逻辑.

####使用限制
从用户使用角度看, 优惠券还会有多种使用限制:
1. 限时间:
优惠券的有效期
2. 限平台
比如设定一种券只能在微信h5平台上使用
3. 限地域
比如只能在上海使用该优惠券
4. 其他限制

限制逻辑保证了优惠券促销花的钱,都用到了对应维度的运营数据上.

需求总结:
- 易变的需求:
 - 对单用户发券的方式(请求量大)
- 稳定的需求: 
 - 发券活动管理(请求量小)
 - 对多用户发券的方式(请求量小)
 - 优惠券的促销方式
 - 优惠券的使用限制

##架构实现

###整体架构
根据功能与性能需求,我们对优惠券系统模块做以下划分:
![图片描述][1]

- 优惠券发券平台
发券平台模块整体部署,数据存储在Mysql,Redis中,可水平扩展.提供一下API:
 - 活动管理API
 - 批量发券API
 - 单用户发券API
 - 查询优惠券API(查询所有优惠券,和查询计算页可用优惠券)
 - 用券API
  
将单用户发券API和批量发券API拆分是因为,两个接口的使用场景不太一样,批量发券的发券量非常大,但时效性要求不高, 可以做更多的优化.

- 优惠券活动平台
提供运营人员管理优惠后台, 给用户抽奖领券的功能.其子模块属于易变的模块, 所以用子系统单独部署的方式对系统整体稳定性更高.子系统包括:
 - 活动管理
 - 批量发放后台
 - 领券子系统(抽奖)
 - 领券子系统(注册返券)
 - 领券子系统(订单返券)
- 优惠券数据统计平台
通过读取线上优惠券数据的备份,进行数据报表生成的平台, 提供运营数据分析是使用, 后续不再做介绍.

领券子系统都依赖于*优惠券发券平台*的*单用户发券接口*,属于优惠券的上层业务子系统. 
 


  [1]: https://segmentfault.com/img/bVyqCn